<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Property Listing Readiness Gate - AGI Automations</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            agi: {
              primary: '#4338ca', // Indigo 700
              accent: '#6366f1',  // Indigo 500
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Custom Scrollbar */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    body { background-color: #f8fafc; color: #0f172a; }
    
    /* Code editor look for the textarea */
    .code-editor {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      background-color: #ffffff;
      color: #334155;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased selection:bg-indigo-100 selection:text-indigo-800 pb-20">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ---------- Helpers (Unchanged Logic) ----------
    const REQUIRED_SECTION_NAMES = [
      "Property Data Quality",
      "Photos & Floorplans",
      "EPC & Compliance Docs",
      "AML/KYC Checks",
      "Legal Review",
      "Risk",
    ];

    function canonicalize(input) {
      const sortObj = (obj) => {
        if (obj === null || obj === undefined) return obj;
        if (Array.isArray(obj)) return obj.map(sortObj);
        if (typeof obj !== "object") return obj;
        return Object.keys(obj)
          .sort()
          .reduce((acc, k) => {
            acc[k] = sortObj(obj[k]);
            return acc;
          }, {});
      };

      const norm = JSON.parse(JSON.stringify(input));

      if (Array.isArray(norm.sections)) {
        norm.sections = [...norm.sections].sort((a, b) => a.name.localeCompare(b.name));
        norm.sections = norm.sections.map((s) => ({
          ...s,
          items: Array.isArray(s.items)
            ? [...s.items].sort((a, b) => a.title.localeCompare(b.title))
            : [],
        }));
      }

      if (Array.isArray(norm.approvals)) {
        norm.approvals = [...norm.approvals].sort((a, b) =>
          a.role === b.role ? a.name.localeCompare(b.name) : a.role.localeCompare(b.role)
        );
      }

      if (Array.isArray(norm.requiredRoles)) {
        norm.requiredRoles = [...norm.requiredRoles].sort((a, b) => a.localeCompare(b));
      }

      return sortObj(norm);
    }

    async function sha256Hex(str) {
      if (window.crypto && window.crypto.subtle) {
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
        const arr = Array.from(new Uint8Array(buf));
        return arr.map((b) => b.toString(16).padStart(2, "0")).join("");
      }
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash << 5) - hash + str.charCodeAt(i);
        hash |= 0;
      }
      return "fallback_" + Math.abs(hash).toString(16);
    }

    function isValidUrlMaybe(url) {
      if (!url) return true;
      try {
        if (url.startsWith("mailto:")) return true;
        const u = new URL(url);
        return ["http:", "https:"].includes(u.protocol);
      } catch {
        return false;
      }
    }

    const nowISO = () => new Date().toISOString();

    // ---------- Sample Data ----------
    const SAMPLE = {
      logicVersion: "1.0.0",
      sevScaleNote: "Ensure EPC & AML docs are current; portals may reject listings missing required assets.",
      requiredRoles: ["Listing Negotiator", "Compliance Officer", "Branch Manager", "Marketing Lead"],
      rollout: {
        targetPortals: "Rightmove, Zoopla, OTM",
        stagedPush: true,
        contingencyPlan: true,
        oncallNegotiator: true,
        portalPushReady: true,
      },
      sections: [
        {
          name: "Property Data Quality",
          items: [
            {
              title: "Address, price, tenure & key features verified",
              owner: "Listing Negotiator",
              link: "https://example.com/checks/property-data",
              evidenceStatus: "present",
              thresholdMet: true,
            },
            {
              title: "Description & room measurements reviewed",
              owner: "Listing Negotiator",
              link: "https://example.com/checks/description",
              evidenceStatus: "present",
              thresholdMet: true,
            },
          ],
        },
        {
          name: "Photos & Floorplans",
          items: [
            {
              title: "High-res photos uploaded (portal standards)",
              owner: "Marketing Lead",
              link: "https://example.com/assets/photos",
              evidenceStatus: "present",
              thresholdMet: true,
            },
            {
              title: "Floorplan uploaded & readable",
              owner: "Marketing Lead",
              link: "https://example.com/assets/floorplan",
              evidenceStatus: "present",
              thresholdMet: true,
            },
          ],
        },
        {
          name: "EPC & Compliance Docs",
          items: [
            {
              title: "Valid EPC certificate attached",
              owner: "Compliance Officer",
              link: "https://example.com/docs/epc",
              evidenceStatus: "present",
              thresholdMet: true,
            },
            {
              title: "Gas/Electrical safety docs (if applicable)",
              owner: "Compliance Officer",
              link: "https://example.com/docs/safety",
              evidenceStatus: "present",
              thresholdMet: true,
            },
          ],
        },
        {
          name: "AML/KYC Checks",
          items: [
            {
              title: "Vendor/Landlord identity & AML check passed",
              owner: "Compliance Officer",
              link: "https://example.com/docs/aml",
              evidenceStatus: "present",
              thresholdMet: true,
            },
            {
              title: "Proof of ownership verified",
              owner: "Compliance Officer",
              link: "https://example.com/docs/ownership",
              evidenceStatus: "present",
              thresholdMet: true,
            },
          ],
        },
        {
          name: "Legal Review",
          items: [
            {
              title: "Terms/agency agreement signed",
              owner: "Branch Manager",
              link: "https://example.com/legal/agency-agreement",
              evidenceStatus: "present",
              thresholdMet: true,
            },
            {
              title: "Marketing consents & privacy checked (GDPR)",
              owner: "Compliance Officer",
              link: "https://example.com/legal/gdpr",
              evidenceStatus: "present",
              thresholdMet: true,
            },
          ],
        },
        {
          name: "Risk",
          items: [
            {
              title: "Sensitive PII handling reviewed & minimised",
              owner: "Compliance Officer",
              link: "https://example.com/risk/pii",
              evidenceStatus: "present",
              thresholdMet: true,
            },
            {
              title: "Reputational/legal flags cleared",
              owner: "Branch Manager",
              link: "https://example.com/risk/flags",
              evidenceStatus: "present",
              thresholdMet: true,
            },
          ],
        },
      ],
      approvals: [
        { role: "Listing Negotiator", name: "A. Patel", approved: true, approvedAtISO: nowISO() },
        { role: "Compliance Officer", name: "B. Nguyen", approved: true, approvedAtISO: nowISO() },
        { role: "Branch Manager", name: "C. Jones", approved: true, approvedAtISO: nowISO() },
        { role: "Marketing Lead", name: "D. Chen", approved: true, approvedAtISO: nowISO() },
      ],
    };

    // ---------- UI Components ----------
    function Badge({ ok, label }) {
      return (
        <span className={`inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium border ${
          ok 
            ? "bg-emerald-50 text-emerald-700 border-emerald-200" 
            : "bg-rose-50 text-rose-700 border-rose-200"
        }`}>
          <i className={`fa-solid ${ok ? "fa-check" : "fa-xmark"} text-[10px]`}></i>
          {label}
        </span>
      );
    }

    function SectionCard({ section, onToggleItemEvidence, onToggleItemThreshold }) {
      return (
        <div className="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
          <div className="mb-4 pb-2 border-b border-slate-100 flex items-center justify-between">
            <h3 className="text-sm font-bold text-slate-800 uppercase tracking-wide">{section.name}</h3>
            <span className="text-xs text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full">{section.items.length} checks</span>
          </div>
          <div className="space-y-4">
            {section.items.map((it, idx) => (
              <div key={idx} className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div className="min-w-0 flex-1">
                  <div className="font-medium text-slate-800 text-sm">{it.title}</div>
                  <div className="text-xs text-slate-500 flex items-center gap-2 mt-0.5">
                    <span>Owner: {it.owner}</span>
                    {it.link ? (
                      <a className="text-indigo-600 hover:underline flex items-center gap-1" href={it.link} target="_blank" rel="noreferrer">
                        <i className="fa-solid fa-link text-[10px]"></i> Check Link
                      </a>
                    ) : (
                      <span className="text-slate-300">No link</span>
                    )}
                  </div>
                </div>
                <div className="flex items-center gap-2 shrink-0">
                  <button
                    onClick={() => onToggleItemEvidence(section.name, it.title)}
                    className={`rounded-md px-2 py-1 text-xs font-semibold shadow-sm transition border ${
                      it.evidenceStatus === "present"
                        ? "bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100"
                        : "bg-white border-slate-300 text-slate-400 hover:bg-slate-50 hover:text-slate-600"
                    }`}
                    title="Toggle evidence"
                  >
                    Evidence
                  </button>
                  <button
                    onClick={() => onToggleItemThreshold(section.name, it.title)}
                    className={`rounded-md px-2 py-1 text-xs font-semibold shadow-sm transition border ${
                      it.thresholdMet 
                        ? "bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100" 
                        : "bg-white border-slate-300 text-slate-400 hover:bg-slate-50 hover:text-slate-600"
                    }`}
                    title="Toggle threshold"
                  >
                    Threshold
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Toggle({ label, checked, onChange }) {
      return (
        <label className="flex cursor-pointer items-center justify-between rounded-lg border border-slate-200 bg-white p-3 shadow-sm hover:bg-slate-50 transition">
          <span className="text-xs font-medium text-slate-700">{label}</span>
          <div className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${checked ? 'bg-indigo-600' : 'bg-slate-200'}`}>
            <span className={`inline-block h-3.5 w-3.5 transform rounded-full bg-white transition-transform ${checked ? 'translate-x-4.5' : 'translate-x-1'}`} style={{ transform: checked ? 'translateX(18px)' : 'translateX(4px)' }} />
            <input type="checkbox" className="sr-only" checked={checked} onChange={(e) => onChange(e.target.checked)} />
          </div>
        </label>
      );
    }

    function Pill({ children }) {
      return <span className="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600 border border-slate-200">{children}</span>;
    }

    // ---------- Main Application ----------
    function App() {
      const [data, setData] = useState(() => SAMPLE);
      const [jsonDraft, setJsonDraft] = useState(() => JSON.stringify(SAMPLE, null, 2));
      const [jsonErr, setJsonErr] = useState("");

      const baselineKey = "plrg_baseline_v1";
      const [baseline, setBaseline] = useState(() => {
        try {
          const raw = localStorage.getItem(baselineKey);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      });

      const canonical = useMemo(() => canonicalize(data), [data]);
      const canonicalStr = useMemo(() => JSON.stringify(canonical), [canonical]);
      const [hash, setHash] = useState("...");

      useEffect(() => {
        (async () => setHash(await sha256Hex(canonicalStr)))();
      }, [canonicalStr]);

      // --- Logic ---
      const allItems = useMemo(
        () => (data.sections || []).flatMap((s) => (s.items || []).map((it) => ({ ...it, section: s.name }))),
        [data]
      );

      const anyThresholdUnmet = allItems.some((it) => !it.thresholdMet);
      const anyEvidenceMissing = allItems.some((it) => it.evidenceStatus !== "present");

      const requiredSectionSet = new Set(REQUIRED_SECTION_NAMES);
      const providedSectionSet = new Set((data.sections || []).map((s) => s.name));
      const missingSections = [...requiredSectionSet].filter((name) => !providedSectionSet.has(name));

      const badLinks = allItems
        .filter((it) => it.link && !isValidUrlMaybe(it.link))
        .map((it) => ({ section: it.section, title: it.title, link: it.link }));

      const requiredRoles = Array.isArray(data.requiredRoles) ? data.requiredRoles : [];
      const approvals = Array.isArray(data.approvals) ? data.approvals : [];
      const approvedRolesSet = new Set(
        approvals.filter((a) => a.approved).map((a) => a.role)
      );
      const missingRequiredRoles = requiredRoles.filter((r) => !approvedRolesSet.has(r));
      const approvalsComplete = missingRequiredRoles.length === 0 && requiredRoles.length > 0;

      const rolloutOk = !!(data.rollout?.oncallNegotiator && data.rollout?.contingencyPlan && data.rollout?.portalPushReady);

      const go = !anyThresholdUnmet && !anyEvidenceMissing && approvalsComplete && rolloutOk;

      const reasons = [];
      if (anyThresholdUnmet) reasons.push("At least one threshold is unmet.");
      if (anyEvidenceMissing) reasons.push("At least one item is missing evidence.");
      if (!rolloutOk) reasons.push("Portal pre-checks must be in place.");
      if (!approvalsComplete) reasons.push("Required roles are not fully approved.");
      if (missingSections.length) reasons.push("Missing required sections: " + missingSections.join(", "));
      if (badLinks.length) reasons.push("One or more links are invalid URLs.");

      const evidenceDiff = useMemo(() => {
        if (!baseline || !baseline.data) return [];
        const prev = (baseline.data.sections || []).flatMap((s) =>
          (s.items || []).map((it) => ({
            section: s.name,
            title: it.title,
            evidenceStatus: it.evidenceStatus,
          }))
        );
        const curr = allItems;
        return curr.filter((it) => {
          const prevItem = prev.find((p) => p.section === it.section && p.title === it.title);
          return prevItem && prevItem.evidenceStatus !== "present" && it.evidenceStatus === "present";
        });
      }, [baseline, allItems]);

      // --- Handlers ---
      const tryApplyJson = () => {
        try {
          const parsed = JSON.parse(jsonDraft);
          setData(parsed);
          setJsonErr("");
        } catch (e) {
          setJsonErr(String(e.message || e));
        }
      };

      const setBaselineNow = async () => {
        const payload = { savedAtISO: nowISO(), hash, data: canonical };
        localStorage.setItem(baselineKey, JSON.stringify(payload));
        setBaseline(payload);
      };

      const clearBaseline = () => {
        localStorage.removeItem(baselineKey);
        setBaseline(null);
      };

      const exportCurrent = async () => {
        const out = {
          exportedAtISO: nowISO(),
          logicVersion: data.logicVersion || "",
          canonicalHash: hash,
          decision: go ? "GO" : "NO-GO",
          reasons: go ? [] : reasons,
          payload: canonical,
        };
        const blob = new Blob([JSON.stringify(out, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `property-readiness-${hash.substring(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const copyJson = async () => {
        await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
      };

      const onToggleItemEvidence = (sectionName, title) => {
        setData((prev) => ({
          ...prev,
          sections: prev.sections.map((s) =>
            s.name === sectionName
              ? { ...s, items: s.items.map((it) => it.title === title ? { ...it, evidenceStatus: it.evidenceStatus === "present" ? "missing" : "present" } : it) }
              : s
          ),
        }));
      };

      const onToggleItemThreshold = (sectionName, title) => {
        setData((prev) => ({
          ...prev,
          sections: prev.sections.map((s) =>
            s.name === sectionName
              ? { ...s, items: s.items.map((it) => it.title === title ? { ...it, thresholdMet: !it.thresholdMet } : it) }
              : s
          ),
        }));
      };

      const setRolloutField = (k, v) => setData((p) => ({ ...p, rollout: { ...p.rollout, [k]: v } }));
      const toggleApproval = (role, name) => {
        setData((p) => ({
          ...p,
          approvals: p.approvals.map((a) =>
            a.role === role && a.name === name
              ? { ...a, approved: !a.approved, approvedAtISO: !a.approved ? nowISO() : undefined }
              : a
          ),
        }));
      };

      const addMissingRequiredApprovals = () => {
        setData((p) => {
          const existingRoles = new Set(p.approvals.map((a) => a.role));
          const toAdd = (p.requiredRoles || []).filter((r) => !existingRoles.has(r));
          if (toAdd.length === 0) return p;
          return {
            ...p,
            approvals: [
              ...p.approvals,
              ...toAdd.map((r) => ({ role: r, name: "(unassigned)", approved: false })),
            ],
          };
        });
      };

      const approveAllRequired = () => {
        setData((p) => ({
          ...p,
          approvals: p.approvals.map((a) =>
            (p.requiredRoles || []).includes(a.role) ? { ...a, approved: true, approvedAtISO: nowISO() } : a
          ),
        }));
      };

      return (
        <div className="max-w-7xl mx-auto p-4 md:p-6 pb-24">
          
          {/* Sticky Action Bar */}
          <div className="sticky top-0 z-30 -mx-4 md:-mx-6 px-4 md:px-6 py-3 bg-slate-50/90 backdrop-blur border-b border-slate-200 flex items-center gap-2 overflow-x-auto hide-scrollbar mb-6 shadow-sm">
            <span className="font-bold text-slate-700 mr-2 shrink-0">AGI Automations</span>
            <div className="h-4 w-px bg-slate-300 mx-2"></div>
            
            <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${go ? "bg-emerald-100 text-emerald-800 border border-emerald-200" : "bg-rose-100 text-rose-800 border border-rose-200"}`}>
                {go ? "READY FOR PUSH" : "NOT READY"}
            </span>

            <div className="ml-auto flex gap-2">
              <button onClick={exportCurrent} className="shrink-0 px-3 py-1.5 rounded border border-slate-300 bg-white text-slate-600 text-xs font-medium hover:bg-slate-50 shadow-sm flex items-center gap-1">
                <i className="fa-solid fa-file-export"></i> Export
              </button>
              <button onClick={setBaselineNow} className="shrink-0 px-3 py-1.5 rounded border border-slate-300 bg-white text-slate-600 text-xs font-medium hover:bg-slate-50 shadow-sm flex items-center gap-1">
                <i className="fa-solid fa-camera"></i> Snapshot
              </button>
            </div>
          </div>

          {/* Header */}
          <header className="mb-8">
            <div className="flex flex-col md:flex-row md:items-end justify-between gap-4">
              <div>
                <div className="inline-flex items-center gap-2 mb-2">
                  <span className="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-indigo-100 text-indigo-800 border border-indigo-200">Compliance & Audit</span>
                  <span className="text-slate-400 text-xs">Hash: {hash.slice(0, 8)}...</span>
                </div>
                <h1 className="text-3xl font-bold text-slate-900 tracking-tight">Property Listing Readiness Gate</h1>
                <p className="text-slate-500 mt-1 text-lg">Automated Pre-Flight Checks for Portal Push</p>
              </div>
              <div className="text-right text-xs text-slate-400">
                Logic Version: <span className="font-mono text-slate-600">{data.logicVersion}</span>
              </div>
            </div>
          </header>

          {/* Decision Card */}
          <div className={`mb-8 rounded-lg border p-6 shadow-sm transition-colors ${go ? "bg-emerald-50/50 border-emerald-200" : "bg-white border-slate-200"}`}>
            <div className="flex flex-col md:flex-row items-center justify-between gap-6">
                <div className="flex items-center gap-4">
                    <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-sm ${go ? "bg-emerald-100 text-emerald-600" : "bg-rose-100 text-rose-600"}`}>
                        <i className={`fa-solid ${go ? "fa-check" : "fa-hand"}`}></i>
                    </div>
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 uppercase tracking-wide">Listing Decision</h2>
                        <div className={`text-4xl font-extrabold tracking-tight ${go ? "text-emerald-600" : "text-rose-600"}`}>
                            {go ? "GO" : "NO-GO"}
                        </div>
                    </div>
                </div>
                
                {!go && (
                    <div className="flex-1 bg-rose-50 rounded-lg p-4 border border-rose-100 w-full md:w-auto">
                        <h3 className="text-xs font-bold text-rose-800 uppercase mb-2">Blocking Issues</h3>
                        <ul className="space-y-1 text-sm text-rose-700">
                            {reasons.map((r, i) => (
                                <li key={i} className="flex items-start gap-2">
                                    <i className="fa-solid fa-circle-exclamation mt-1 text-xs"></i>
                                    {r}
                                </li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>
          </div>

          <div className="grid grid-cols-1 gap-6 lg:grid-cols-3">
            
            {/* Left: Inputs */}
            <div className="lg:col-span-2 space-y-6">
              
              {/* Rollout Checks */}
              <div className="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
                <h2 className="mb-4 text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2">
                    <i className="fa-solid fa-rocket text-slate-400"></i> Portal Push Config
                </h2>
                <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
                  <div className="col-span-1 sm:col-span-2 mb-2">
                    <label className="block text-xs font-medium text-slate-500 mb-1">Target Portals</label>
                    <input
                      value={data.rollout?.targetPortals || ''}
                      onChange={(e) => setRolloutField('targetPortals', e.target.value)}
                      className="w-full rounded border border-slate-300 px-3 py-2 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  <Toggle label="Staged Push (Pilot)" checked={!!data.rollout?.stagedPush} onChange={(v) => setRolloutField('stagedPush', v)} />
                  <Toggle label="Contingency Plan" checked={!!data.rollout?.contingencyPlan} onChange={(v) => setRolloutField('contingencyPlan', v)} />
                  <Toggle label="On-call Negotiator" checked={!!data.rollout?.oncallNegotiator} onChange={(v) => setRolloutField('oncallNegotiator', v)} />
                  <Toggle label="Tech Pre-checks" checked={!!data.rollout?.portalPushReady} onChange={(v) => setRolloutField('portalPushReady', v)} />
                </div>
              </div>

              {/* Sections */}
              <div className="grid grid-cols-1 gap-4">
                {(data.sections || []).map((s, i) => (
                  <SectionCard key={i} section={s} onToggleItemEvidence={onToggleItemEvidence} onToggleItemThreshold={onToggleItemThreshold} />
                ))}
              </div>

              {/* Approvals */}
              <div className="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
                <div className="mb-4 flex items-center justify-between border-b border-slate-100 pb-2">
                  <h2 className="text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2">
                    <i className="fa-solid fa-signature text-slate-400"></i> Role Approvals
                  </h2>
                  <div className="flex gap-2">
                    <button onClick={addMissingRequiredApprovals} className="text-xs font-medium text-slate-500 hover:text-indigo-600">Add Missing</button>
                    <button onClick={approveAllRequired} className="text-xs font-bold text-indigo-600 hover:text-indigo-700 bg-indigo-50 px-2 py-1 rounded">Approve All</button>
                  </div>
                </div>
                
                <div className="overflow-hidden rounded border border-slate-200">
                  <table className="min-w-full divide-y divide-slate-100">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Role</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Name</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Time</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 bg-white">
                      {(data.approvals || []).map((a, i) => (
                        <tr key={i} className="hover:bg-slate-50">
                          <td className="px-4 py-2 text-sm font-medium text-slate-700">{a.role}</td>
                          <td className="px-4 py-2 text-sm text-slate-600">{a.name}</td>
                          <td className="px-4 py-2 text-sm">
                            <button
                              onClick={() => toggleApproval(a.role, a.name)}
                              className={`rounded-full px-2.5 py-0.5 text-[10px] font-bold uppercase tracking-wide transition ${a.approved ? "bg-emerald-100 text-emerald-700" : "bg-slate-100 text-slate-500 hover:bg-slate-200"}`}
                            >
                              {a.approved ? "Approved" : "Pending"}
                            </button>
                          </td>
                          <td className="px-4 py-2 text-xs font-mono text-slate-400">{a.approvedAtISO ? a.approvedAtISO.split('T')[1].split('.')[0] : '-'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                {!approvalsComplete && (
                  <div className="mt-3 flex items-center gap-2 text-xs text-rose-600 bg-rose-50 px-3 py-2 rounded">
                    <i className="fa-solid fa-triangle-exclamation"></i>
                    Missing: {missingRequiredRoles.join(", ") || "(none)"}
                  </div>
                )}
              </div>

              {/* JSON Editor */}
              <div className="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
                <div className="mb-3 flex items-center justify-between">
                  <h2 className="text-sm font-bold text-slate-800 uppercase tracking-wide">Data Source</h2>
                  <div className="flex items-center gap-2">
                    <button onClick={() => setJsonDraft(JSON.stringify(SAMPLE, null, 2))} className="text-xs font-medium text-slate-500 hover:text-slate-700">Reset</button>
                    <button onClick={tryApplyJson} className="rounded bg-indigo-600 px-3 py-1 text-xs font-semibold text-white shadow-sm hover:bg-indigo-700">Apply Changes</button>
                  </div>
                </div>
                <textarea
                  value={jsonDraft}
                  onChange={(e) => setJsonDraft(e.target.value)}
                  className="h-48 w-full code-editor rounded border border-slate-300 p-3 outline-none focus:ring-2 focus:ring-indigo-500"
                />
                {jsonErr && <div className="mt-2 text-xs text-rose-600 font-medium">Error: {jsonErr}</div>}
              </div>
            </div>

            {/* Right: Tests & Audit */}
            <div className="space-y-6">
              
              {/* Automated Tests */}
              <div className="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
                <h2 className="mb-4 text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2">
                    <i className="fa-solid fa-robot text-slate-400"></i> Auto-Verification
                </h2>
                <ul className="space-y-3">
                  <li className="flex items-center justify-between text-sm text-slate-600">
                    <span>Required Sections</span>
                    <Badge ok={missingSections.length === 0} label={missingSections.length === 0 ? "Pass" : "Fail"} />
                  </li>
                  <li className="flex items-center justify-between text-sm text-slate-600">
                    <span>Valid Links</span>
                    <Badge ok={badLinks.length === 0} label={badLinks.length === 0 ? "Pass" : "Fail"} />
                  </li>
                  <li className="flex items-center justify-between text-sm text-slate-600">
                    <span>Thresholds Met</span>
                    <Badge ok={!anyThresholdUnmet} label={!anyThresholdUnmet ? "Pass" : "Fail"} />
                  </li>
                  <li className="flex items-center justify-between text-sm text-slate-600">
                    <span>Pre-checks</span>
                    <Badge ok={rolloutOk} label={rolloutOk ? "Pass" : "Fail"} />
                  </li>
                </ul>
              </div>

              {/* Audit Trail */}
              <div className="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
                <h2 className="mb-4 text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2">
                    <i className="fa-solid fa-clock-rotate-left text-slate-400"></i> Audit Trail
                </h2>
                
                <div className="space-y-4">
                    <div className="bg-slate-50 p-3 rounded border border-slate-100">
                        <div className="text-[10px] uppercase text-slate-400 font-bold mb-1">Current State</div>
                        <div className="font-mono text-xs text-slate-600 break-all">{hash}</div>
                    </div>

                    {baseline ? (
                        <div className="bg-slate-50 p-3 rounded border border-slate-100">
                            <div className="flex justify-between items-start mb-1">
                                <div className="text-[10px] uppercase text-slate-400 font-bold">Baseline</div>
                                <button onClick={clearBaseline} className="text-[10px] text-rose-500 hover:underline">Clear</button>
                            </div>
                            <div className="text-xs text-slate-800 mb-1">{new Date(baseline.savedAtISO).toLocaleString()}</div>
                            <div className="font-mono text-[10px] text-slate-400 break-all">{baseline.hash}</div>
                        </div>
                    ) : (
                        <div className="text-center p-4 border-2 border-dashed border-slate-200 rounded text-xs text-slate-400">
                            No baseline set.
                        </div>
                    )}

                    {evidenceDiff.length > 0 && (
                        <div className="bg-emerald-50 p-3 rounded border border-emerald-100">
                            <div className="text-[10px] uppercase text-emerald-700 font-bold mb-1">New Evidence Added</div>
                            <ul className="list-disc pl-4 text-xs text-emerald-800 space-y-1">
                                {evidenceDiff.map((d, i) => (
                                    <li key={i}>{d.title}</li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
              </div>
              
              {/* Note */}
              <div className="rounded-lg bg-amber-50 p-4 border border-amber-100 text-xs text-amber-800">
                <strong>Sev Scale Note:</strong> {data.sevScaleNote}
              </div>

            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>